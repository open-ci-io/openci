name: Benchmark
on:
  workflow_dispatch:
  pull_request:
    branches:
      - develop

jobs:
  benchmark:
    strategy:
      matrix:
        runner: [ubuntu-latest, openci-runner-beta-dev]
    runs-on: ${{ matrix.runner }}
    timeout-minutes: 15
    steps:
      - name: Install sysbench
        run: |
          sudo apt-get update
          sudo apt-get install -y sysbench

      - name: System Info
        run: |
          echo "=== CPU Info ==="
          nproc
          cat /proc/cpuinfo | grep "model name" | head -1 || true
          echo ""
          echo "=== Memory Info ==="
          free -h

      - name: Sysbench CPU (single-thread)
        run: |
          echo "=== CPU Benchmark (single-thread, 60s) ==="
          sysbench cpu --cpu-max-prime=20000 --threads=1 --time=60 run

      - name: Sysbench CPU (multi-thread)
        run: |
          echo "=== CPU Benchmark (multi-thread, 60s) ==="
          sysbench cpu --cpu-max-prime=20000 --threads=$(nproc) --time=60 run

      - name: Sysbench Memory
        run: |
          echo "=== Memory Benchmark (60s) ==="
          sysbench memory --memory-block-size=1M --memory-total-size=100G --threads=$(nproc) run

      - name: Sysbench FileIO Prepare
        run: |
          echo "=== Preparing FileIO test files ==="
          sysbench fileio --file-total-size=2G prepare

      - name: Sysbench FileIO (random read/write)
        run: |
          echo "=== FileIO Benchmark (random r/w, 60s) ==="
          sysbench fileio --file-total-size=2G --file-test-mode=rndrw --time=60 --threads=$(nproc) run

      - name: Sysbench FileIO Cleanup
        run: |
          sysbench fileio --file-total-size=2G cleanup
